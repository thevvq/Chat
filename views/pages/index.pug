extends ../layouts/default.pug

block contentList
    h4 Cuộc trò chuyện gần đây
    if rooms && rooms.length > 0
        each room in rooms
            // Tìm user còn lại nếu là phòng bạn bè
            - var roomName = ''
            - var otherUser = null
            - var myId = (user && user.id) ? user.id.toString() : (user && user._id ? user._id.toString() : '')

            if room.typeRoom === 'friend' && room.users && room.users.length === 2
                - otherUser = room.users.find(u => u.user_id_str !== myId)
                - roomName = otherUser && otherUser.fullName ? otherUser.fullName : 'Bạn bè'
            else if room.typeRoom === 'group'
                - roomName = `Nhóm (${room.users ? room.users.length : 0} thành viên)`
            else
                - roomName = room.typeRoom || 'Phòng chat'

            a(href=`/${room._id}` class='conversation' data-room-id=room._id)
                // Chèn Avatar cho danh sách chat
                if otherUser && otherUser.avatar
                    img(src=otherUser.avatar alt=roomName class='avatar')
                else
                    img(src='/images/default-avatar.jpg' alt='Avatar mặc định' class='avatar')

                .info 
                    strong #{roomName}
                    if room.lastPreview
                        - const sender = room.lastPreview.sender || ''
                        - const content = room.lastPreview.content || ''
                        span #{sender}: #{content}
    else
        .conversation
            strong Không có cuộc trò chuyện nào
            span Tạo phòng mới hoặc đợi lời mời

bblock main
    if !currentRoomID
        .main-welcome
            // Avatar lớn + hiệu ứng glow nhẹ
            .welcome-avatar
                if user && user.avatar
                    img(src=user.avatar alt=user.fullName)
                else
                    img(src='/images/default-avatar.jpg' alt='Avatar')

            h3 Chào mừng bạn trở lại, #{user ? user.fullName.split(' ')[0] : 'bạn'}!
            p.text-muted.mt-3 
                | Hiện tại chưa có cuộc trò chuyện nào đang diễn ra.
                br
                | Hãy chọn một người bạn hoặc tạo phòng chat mới ngay nào!

            // 2 nút CTA nổi bật, đúng chuẩn theme
            .welcome-actions.mt-4
                a.btn.btn-primary.btn-lg(href="/friends" title="Tìm bạn bè")
                    i.fa-solid.fa-user-plus.me-2
                    | Tìm bạn bè
                a.btn.btn-outline-light.btn-lg.ms-3(href="/rooms/new" title="Tạo phòng chat")
                    i.fa-solid.fa-comment-dots.me-2
                    | Tạo phòng chat

            // Hiệu ứng hạt rơi nhẹ (tùy chọn, rất chill)
            .welcome-particles
                - for (let i = 0; i < 30; i++)
                    span.particle

    else
        // ─── PHẦN CHAT ĐÃ CÓ PHÒNG (giữ nguyên logic cũ nhưng fix nhỏ) ───
        .inner-body(my-id=user.id my-name=user.fullName)
            for chat in chats
                div(class=chat.user_id == user.id ? 'inner-outgoing' : 'inner-incoming')

                    if chat.user_id != user.id
                        if chat.infoUser && chat.infoUser.avatar
                            img(src=chat.infoUser.avatar alt=chat.infoUser.fullName class='chat-avatar')
                        else
                            img(src='/images/default-avatar.jpg' alt='Avatar mặc định' class='chat-avatar')

                    .message-group
                        if chat.user_id != user.id
                            if chat.infoUser
                                .inner-name #{chat.infoUser.fullName}
                            else
                                .inner-name Không rõ

                        if chat.content
                            .inner-content !{chat.content}   

                        if chat.images && chat.images.length > 0
                            .inner-images
                                for image in chat.images
                                    img(src=image alt="Hình ảnh" class="chat-image")

            .inner-list-typing   

        // Footer nhập tin nhắn (giữ nguyên + thêm class cho dễ style)
        .inner-foot
            form.inner-form(action='' autocomplete="off")
                input(type="text" placeholder='Aa...' name='content')
                
                label.btn-emoji(for="emoji-picker-toggle" title="Chọn emoji")
                    i.fa-regular.fa-face-smile
                input#emoji-picker-toggle(type="checkbox" hidden)
                
                button(type='submit' title="Gửi")
                    i.fa-solid.fa-paper-plane

            // Emoji picker (dùng thư viện emoji-picker-element hoặc lite-version)
            <emoji-picker class="light"></emoji-picker>