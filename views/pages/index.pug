extends ../layouts/default.pug

block contentList

    h4 Cuộc trò chuyện gần đây
    if rooms && rooms.length > 0
        each room in rooms
            - var roomName = ''
            - var otherUser = null
            - var myId = (user && user.id) ? user.id.toString() : ''

            if room.typeRoom === 'friend' && room.users && room.users.length === 2
                - otherUser = room.users.find(u => u.user_id_str !== myId)
                - roomName = otherUser ? otherUser.fullName : 'Bạn bè'
            else if room.typeRoom === 'group'
                - roomName = `Nhóm (${room.users.length} thành viên)`
            else
                - roomName = room.typeRoom || 'Phòng chat'

            a(href=`/${room._id}` class='conversation')
                strong #{roomName}

                if room.lastPreview
                    span #{room.lastPreview.sender}: #{room.lastPreview.content}
    else
        .conversation
            strong Không có cuộc trò chuyện nào
            span Tạo phòng mới hoặc đợi lời mời


block main
    if !currentRoomID
        .main-welcome
            h3 Chào mừng bạn đến với Chat!
            p Chọn một cuộc trò chuyện ở bên trái để bắt đầu hoặc tạo phòng mới.
    else
        .inner-body(my-id=user.id)
            for chat in chats
                div(class=(chat.user_id == user.id ? 'inner-outgoing' : 'inner-incoming'))
                    if chat.user_id != user.id && chat.infoUser
                        .inner-name #{chat.infoUser.fullName}

                    if chat.content
                        .inner-content #{chat.content}

                    if chat.images && chat.images.length > 0
                        .inner-images
                            for image in chat.images
                                img(src=image alt="image" class="chat-image")

            .inner-list-typing

        .inner-foot
            form(class='inner-form' action='' enctype="multipart/form-data")
                input(type="file" id="imageInput" accept="image/*" hidden)
                label(for="imageInput" class="button-icon btn btn-light mx-2")
                    i.fa-solid.fa-image

                input(type="text" placeholder='Nhập nội dung...' name='content' autocomplete="off")

                span(class='button-icon btn btn-light mx-2') 
                    i.fa-regular.fa-face-smile

                button(type="submit")
                    i.fa-solid.fa-paper-plane

        div(class='tooltip' role='tooltip')
            emoji-picker

block script
    script.
        const socket = _io;

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append("image", file);

            const res = await fetch("/api/upload-image", {
                method: "POST",
                body: formData,
            });

            const data = await res.json();
            return data.imageUrl;
        }

        document.getElementById("imageInput").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = await uploadImage(file);

            socket.emit("client-send-message", {
                type: "image",
                images: [url],
            });
        });

        document.querySelector(".inner-form").addEventListener("submit", (e) => {
            e.preventDefault();
            const input = document.querySelector("input[name='content']");
            if (!input.value.trim()) return;

            socket.emit("client-send-message", {
                type: "text",
                content: input.value
            });

            input.value = "";
        });
